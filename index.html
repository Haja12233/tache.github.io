<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrice 4x4 - Gestion de T√¢che</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 15px;
        }

        .container {
            width: 100%;
            max-width: 700px;
            background: #ffffff;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .cell {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            aspect-ratio: 1/1;
            border: 1px solid #dcdcdc;
            border-radius: 8px;
            font-size: 14px;
            color: #333;
            background-color: #fff;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            padding: 8px;
            text-align: center;
            word-break: break-word;
        }

        .cell:hover:not(.empty-cell):not(.default-user-active) {
            border-color: #007bff;
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.2);
        }
        
        .empty-cell {
            background-color: #f8f9fa;
            border-style: dashed;
            cursor: default;
        }

        .cell-content {
            font-weight: 500;
        }

        .cell button {
            width: 100%;
            height: 100%;
            border: none;
            background: #007bff;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: background-color 0.2s;
            padding: 5px;
        }
        
        .cell button:hover {
            background: #0056b3;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background-color: white;
            border: 1px solid #dcdcdc;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 10;
            max-height: 150px;
            overflow-y: auto;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            padding: 8px 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background-color: #f0f2f5;
        }
        
        .dropdown-item-content {
            flex-grow: 1;
        }

        .add-item {
            font-style: italic;
            color: #007bff;
            background-color: #f8f9fa;
            text-align: center;
            font-weight: bold;
        }

        .text-green {
            color: #28a745;
            font-weight: bold;
        }

        .text-red {
            color: #dc3545;
            font-weight: bold;
        }

        /* Style pour le nom par d√©faut */
        .default-user {
            opacity: 0.7;
            font-style: italic;
        }

        /* Style pour la cellule D1 quand un utilisateur par d√©faut est actif */
        .default-user-active {
            cursor: default;
        }

        .default-user-active .cell-content {
            opacity: 0.7;
            font-style: italic;
        }

        /* Style pour les √©l√©ments par d√©faut dans A1 - transparent */
        .default-a1-item {
            opacity: 0.6;
            background-color: #e9ecef;
            font-weight: bold;
        }

        /* Style pour les √©l√©ments expir√©s */
        .expired-item {
            opacity: 0.4;
            background-color: #f8d7da;
            color: #721c24;
            font-style: italic;
        }

        /* Bouton d'actualisation */
        #refresh-button {
            margin-top: 20px;
            padding: 12px 25px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        #refresh-button:hover {
            background-color: #218838;
        }

        /* Notification */
        #notification-banner {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 25px;
            background-color: #28a745;
            color: white;
            font-weight: bold;
            font-size: 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 100;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
            max-width: 90%;
            text-align: center;
        }

        #notification-banner.show {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            h1 {
                font-size: 1.3rem;
            }
            .grid {
                gap: 8px;
            }
            .cell {
                font-size: 12px;
                padding: 6px;
            }
            .cell button {
                font-size: 11px;
            }
            .dropdown-item {
                padding: 6px 8px;
                font-size: 12px;
            }
            #refresh-button {
                padding: 10px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>

<div id="notification-banner">T√¢che compl√®te ! üéâ</div>

<div class="container">
    <h1>Projet II: Gestion de T√¢che</h1>
    <div class="grid">
        <div class="cell" id="a1" data-initial-text="Locale">
            <span class="cell-content">Locale</span>
            <div class="dropdown-menu"></div>
        </div>
        <div class="cell empty-cell" id="b1" data-initial-text="">
        </div>
        <div class="cell empty-cell" id="c1" data-initial-text="">
        </div>
        <div class="cell" id="d1" data-initial-text="Utilisateur">
            <span class="cell-content">Utilisateur</span>
            <div class="dropdown-menu"></div>
        </div>

        <div class="cell" id="a2" data-initial-text="D√©but T√¢che"><button>D√©but T√¢che</button></div>
        <div class="cell empty-cell" id="b2" data-initial-text="">
        </div>
        <div class="cell" id="c2" data-initial-text="Contr√¥le Rat">
            <span class="cell-content">Contr√¥le Rat</span>
            <div class="dropdown-menu"></div>
        </div>
        <div class="cell empty-cell" id="d2" data-initial-text="">
        </div>

        <div class="cell" id="a3" data-initial-text="Fin T√¢che"><button>Fin T√¢che</button></div>
        <div class="cell empty-cell" id="b3" data-initial-text="">
        </div>
        <div class="cell" id="c3" data-initial-text="Contr√¥le Xylophage">
            <span class="cell-content">Contr√¥le Xylophage</span>
            <div class="dropdown-menu"></div>
        </div>
        <div class="cell empty-cell" id="d3" data-initial-text="">
        </div>

        <div class="cell" id="a4" data-initial-text="A4">
            <span class="cell-content">A4</span>
            <div class="dropdown-menu"></div>
        </div>
        <div class="cell" id="b4" data-initial-text="B4">
            <span class="cell-content">B4</span>
            <div class="dropdown-menu"></div>
        </div>
        <div class="cell" id="c4" data-initial-text="C4">
            <span class="cell-content">C4</span>
            <div class="dropdown-menu"></div>
        </div>
        <div class="cell" id="d4" data-initial-text="D4">
            <span class="cell-content">D4</span>
            <div class="dropdown-menu"></div>
        </div>
    </div>
    
    <button id="refresh-button">üîÑ Actualiser toutes les cases</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    const initialUsers = ['Anniva', 'Tina'];
    let placesToControl = ['Chambre'];
    let ratMode = false; // Pour suivre si on est en mode Rat
    let coloredItemsC2 = {}; // Pour stocker les √©l√©ments color√©s de C2 avec leurs couleurs
    let defaultUser = null; // Pour stocker l'utilisateur par d√©faut de D1
    let defaultUserExpiry = null; // Pour stocker l'expiration de l'utilisateur par d√©faut de D1
    let defaultLocales = []; // Pour stocker les locales par d√©faut de A1
    let defaultLocalesExpiry = null; // Pour stocker l'expiration des locales par d√©faut de A1
    let lastDefaultLocale = null; // Pour stocker la derni√®re locale s√©lectionn√©e par d√©faut

    // Cases obligatoires
    const requiredCells = ['a1', 'a2', 'a3', 'c2', 'c3', 'd1'];
    // Cases facultatives
    const optionalCells = ['a4', 'b4', 'c4', 'd4'];

    // --- Sauvegarde ---
    function saveResults() {
        const results = {};
        const cellsToSave = ['a1', 'a2', 'a3', 'a4', 'b4', 'c2', 'c3', 'c4', 'd1', 'd4'];
        
        cellsToSave.forEach(id => {
            const cell = document.getElementById(id);
            if (!cell) return;
            
            const initialText = cell.getAttribute('data-initial-text');
            const contentSpan = cell.querySelector('.cell-content');
            const contentButton = cell.querySelector('button');
            
            let currentValue = '';
            let color = '';

            if (contentSpan) {
                currentValue = contentSpan.textContent.trim();
                if (cell.classList.contains('text-green')) {
                    color = 'green';
                } else if (cell.classList.contains('text-red')) {
                    color = 'red';
                }
            } else if (contentButton) {
                currentValue = contentButton.textContent.trim();
            }

            if (currentValue && currentValue !== initialText) {
                results[id] = { value: currentValue, color: color };
            }
        });
        
        localStorage.setItem('taskResults', JSON.stringify(results));
    }

    function loadResults() {
        const savedResults = localStorage.getItem('taskResults');
        if (savedResults) {
            const results = JSON.parse(savedResults);
            
            for (const id in results) {
                const cell = document.getElementById(id);
                if (!cell) continue;
                
                const contentSpan = cell.querySelector('.cell-content');
                const contentButton = cell.querySelector('button');
                
                if (contentSpan) {
                    contentSpan.textContent = results[id].value;
                    if (results[id].color === 'green') {
                        cell.classList.add('text-green');
                    } else if (results[id].color === 'red') {
                        cell.classList.add('text-red');
                    }
                } else if (contentButton) {
                    contentButton.textContent = results[id].value;
                }
            }
        }
    }

    // --- Gestion de l'utilisateur par d√©faut de D1 ---
    function saveDefaultUser() {
        if (defaultUser) {
            const userData = {
                user: defaultUser,
                expiry: defaultUserExpiry
            };
            localStorage.setItem('defaultUserD1', JSON.stringify(userData));
        }
    }

    function loadDefaultUser() {
        const savedDefaultUser = localStorage.getItem('defaultUserD1');
        if (savedDefaultUser) {
            const userData = JSON.parse(savedDefaultUser);
            const now = new Date().getTime();
            
            // V√©rifier si l'utilisateur par d√©faut n'a pas expir√© (8 heures = 28800000 ms)
            if (userData.expiry > now) {
                defaultUser = userData.user;
                defaultUserExpiry = userData.expiry;
                
                // Appliquer l'utilisateur par d√©faut
                const d1Cell = document.getElementById('d1');
                const contentSpan = d1Cell.querySelector('.cell-content');
                contentSpan.textContent = defaultUser;
                contentSpan.classList.add('default-user');
                d1Cell.classList.add('default-user-active');
                
                // Mettre √† jour le menu d√©roulant
                updateD1MenuWithDefault();
            } else {
                // L'utilisateur par d√©faut a expir√©, le supprimer
                localStorage.removeItem('defaultUserD1');
            }
        }
    }

    function setDefaultUser(userName) {
        defaultUser = userName;
        defaultUserExpiry = new Date().getTime() + (8 * 60 * 60 * 1000); // 8 heures en millisecondes
        
        // Appliquer l'utilisateur par d√©faut
        const d1Cell = document.getElementById('d1');
        const contentSpan = d1Cell.querySelector('.cell-content');
        contentSpan.textContent = defaultUser;
        contentSpan.classList.add('default-user');
        d1Cell.classList.add('default-user-active');
        
        // Sauvegarder dans localStorage
        saveDefaultUser();
        
        // Mettre √† jour le menu d√©roulant
        updateD1MenuWithDefault();
        
        // Afficher notification
        showDefaultUserNotification();
    }

    function updateD1MenuWithDefault() {
        const d1Menu = document.querySelector('#d1 .dropdown-menu');
        d1Menu.innerHTML = '';
        
        // Ajouter l'utilisateur par d√©faut en premier avec une indication sp√©ciale
        if (defaultUser) {
            const defaultItem = createDropdownItem(`‚òÖ ${defaultUser} (par d√©faut)`);
            defaultItem.classList.add('default-user-item');
            defaultItem.dataset.defaultUser = 'true';
            d1Menu.appendChild(defaultItem);
        }
        
        // Ajouter les autres utilisateurs
        initialUsers.forEach(user => {
            if (user !== defaultUser) {
                d1Menu.appendChild(createDropdownItem(user));
            }
        });
        
        // Ajouter le bouton +
        const addUserItem = createDropdownItem('+');
        addUserItem.classList.add('add-item');
        d1Menu.appendChild(addUserItem);
    }

    function showDefaultUserNotification() {
        const notification = document.getElementById('notification-banner');
        notification.textContent = `Utilisateur "${defaultUser}" d√©fini par d√©faut pour 8h !`;
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    // --- Gestion des locales par d√©faut de A1 ---
    function saveDefaultLocales() {
        if (defaultLocales.length > 0) {
            const localesData = {
                locales: defaultLocales,
                lastLocale: lastDefaultLocale,
                expiry: defaultLocalesExpiry
            };
            localStorage.setItem('defaultLocalesA1', JSON.stringify(localesData));
        }
    }

    function loadDefaultLocales() {
        const savedDefaultLocales = localStorage.getItem('defaultLocalesA1');
        if (savedDefaultLocales) {
            const localesData = JSON.parse(savedDefaultLocales);
            const now = new Date().getTime();
            
            // V√©rifier si les locales par d√©faut n'ont pas expir√© (8 heures = 28800000 ms)
            if (localesData.expiry > now) {
                defaultLocales = localesData.locales;
                defaultLocalesExpiry = localesData.expiry;
                lastDefaultLocale = localesData.lastLocale;
                
                // Afficher la derni√®re locale s√©lectionn√©e dans la cellule A1
                if (lastDefaultLocale) {
                    const a1Cell = document.getElementById('a1');
                    const contentSpan = a1Cell.querySelector('.cell-content');
                    contentSpan.textContent = lastDefaultLocale;
                    contentSpan.classList.add('default-user');
                }
                
                // Mettre √† jour le menu d√©roulant
                updateA1MenuWithDefaults();
            } else {
                // Les locales par d√©faut ont expir√©, les supprimer
                localStorage.removeItem('defaultLocalesA1');
            }
        }
    }

    function addDefaultLocale(localeName) {
        // Si c'est le premier √©l√©ment par d√©faut, d√©finir l'expiration
        if (defaultLocales.length === 0) {
            defaultLocalesExpiry = new Date().getTime() + (8 * 60 * 60 * 1000); // 8 heures en millisecondes
        }
        
        // Ajouter la locale √† la liste des par d√©faut si elle n'y est pas d√©j√†
        if (!defaultLocales.includes(localeName)) {
            defaultLocales.push(localeName);
        }
        
        // Mettre √† jour la derni√®re locale s√©lectionn√©e
        lastDefaultLocale = localeName;
        
        // Afficher la derni√®re locale dans la cellule A1
        const a1Cell = document.getElementById('a1');
        const contentSpan = a1Cell.querySelector('.cell-content');
        contentSpan.textContent = lastDefaultLocale;
        contentSpan.classList.add('default-user');
        
        // Sauvegarder dans localStorage
        saveDefaultLocales();
        
        // Mettre √† jour le menu d√©roulant
        updateA1MenuWithDefaults();
        
        // Afficher notification
        showDefaultLocaleNotification(localeName);
    }

    function updateA1MenuWithDefaults() {
        const a1Menu = document.querySelector('#a1 .dropdown-menu');
        a1Menu.innerHTML = '';
        
        // Ajouter les locales par d√©faut en premier avec une indication sp√©ciale (style transparent)
        defaultLocales.forEach(localeName => {
            const defaultItem = createDropdownItem(`‚òÖ ${localeName} (par d√©faut)`);
            defaultItem.classList.add('default-a1-item');
            defaultItem.dataset.defaultLocale = 'true';
            a1Menu.appendChild(defaultItem);
        });
        
        // Ajouter les autres locales
        for (let i = 1; i <= 10; i++) {
            const localeName = `P${i}`;
            if (!defaultLocales.includes(localeName)) {
                a1Menu.appendChild(createDropdownItem(localeName));
            }
        }
    }

    function showDefaultLocaleNotification(localeName) {
        const notification = document.getElementById('notification-banner');
        notification.textContent = `Locale "${localeName}" d√©finie comme derni√®re par d√©faut pour 8h !`;
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    // --- Cr√©ation d'√©l√©ments ---
    function createDropdownItem(text) {
        const item = document.createElement('div');
        item.className = 'dropdown-item';
        const contentSpan = document.createElement('span');
        contentSpan.className = 'dropdown-item-content';
        contentSpan.textContent = text;
        item.appendChild(contentSpan);
        return item;
    }

    // --- R√©initialisation C2 ---
    function resetC2() {
        const c2Menu = document.querySelector('#c2 .dropdown-menu');
        c2Menu.innerHTML = '';
        const rItem = createDropdownItem('R');
        rItem.dataset.colorState = '0';
        c2Menu.appendChild(rItem);
        const ratItem = createDropdownItem('Rat');
        ratItem.dataset.colorState = '0';
        c2Menu.appendChild(ratItem);
        document.querySelector('#c2 .cell-content').textContent = 'Contr√¥le Rat';
        document.querySelector('#c2').classList.remove('text-green', 'text-red');
        ratMode = false;
        coloredItemsC2 = {};
    }

    // --- Afficher les endroits √† contr√¥ler ---
    function showPlacesToControl() {
        const c2Menu = document.querySelector('#c2 .dropdown-menu');
        c2Menu.innerHTML = '';
        
        // Ajouter les endroits existants
        placesToControl.forEach(place => {
            const item = createDropdownItem(place);
            item.dataset.colorState = '0';
            c2Menu.appendChild(item);
        });
        
        // Ajouter le bouton +
        const addItem = createDropdownItem('+');
        addItem.classList.add('add-item');
        c2Menu.appendChild(addItem);
        
        ratMode = true;
    }

    // --- Mettre √† jour l'affichage des √©l√©ments color√©s dans C2 ---
    function updateColoredDisplay() {
        const cellContent = document.querySelector('#c2 .cell-content');
        const coloredItemsArray = Object.entries(coloredItemsC2);
        
        if (coloredItemsArray.length > 0) {
            // Cr√©er un conteneur pour les textes avec couleurs
            let displayText = '';
            coloredItemsArray.forEach(([text, color], index) => {
                if (index > 0) displayText += ', ';
                if (color === 'green') {
                    displayText += `<span class="text-green">${text}</span>`;
                } else if (color === 'red') {
                    displayText += `<span class="text-red">${text}</span>`;
                } else {
                    displayText += text;
                }
            });
            
            // Utiliser innerHTML pour afficher les couleurs
            cellContent.innerHTML = displayText;
        } else {
            cellContent.textContent = 'Rat';
        }
    }

    function resetAll() {
        const cellsToReset = ['a1', 'a2', 'a3', 'a4', 'b4', 'c2', 'c3', 'c4', 'd1', 'd4'];
        
        cellsToReset.forEach(id => {
            const cell = document.getElementById(id);
            if (!cell) return;
            
            const initialText = cell.getAttribute('data-initial-text');
            const contentSpan = cell.querySelector('.cell-content');
            const contentButton = cell.querySelector('button');
            
            if (contentSpan) {
                contentSpan.textContent = initialText;
                contentSpan.classList.remove('default-user');
            } else if (contentButton) {
                contentButton.textContent = initialText;
            }
            cell.classList.remove('text-green', 'text-red', 'default-user-active');
        });

        resetC2();
        saveResults();
        
        // R√©initialiser les valeurs par d√©faut
        defaultUser = null;
        defaultUserExpiry = null;
        defaultLocales = [];
        defaultLocalesExpiry = null;
        lastDefaultLocale = null;
        localStorage.removeItem('defaultUserD1');
        localStorage.removeItem('defaultLocalesA1');
        
        // R√©initialiser les menus d√©roulants
        updateA1MenuWithDefaults();
        updateD1MenuWithDefault();
    }

    // --- Mise √† jour des r√©sultats ---
    function updateResults() {
        const cellsToUpdate = ['a1', 'a2', 'a3', 'a4', 'b4', 'c2', 'c3', 'c4', 'd1', 'd4'];
        
        cellsToUpdate.forEach(id => {
            const cell = document.getElementById(id);
            if (!cell) return;
            
            const initialText = cell.getAttribute('data-initial-text');
            const contentSpan = cell.querySelector('.cell-content');
            const contentButton = cell.querySelector('button');
            
            let currentValue = '';
            let color = '';

            if (contentSpan) {
                currentValue = contentSpan.textContent.trim();
                if (cell.classList.contains('text-green')) {
                    color = 'green';
                } else if (cell.classList.contains('text-red')) {
                    color = 'red';
                }
            } else if (contentButton) {
                currentValue = contentButton.textContent.trim();
            }
        });

        saveResults();
    }

    // --- V√©rification de compl√©tion des cases obligatoires ---
    function checkRequiredCompletion() {
        for (const id of requiredCells) {
            const cell = document.getElementById(id);
            if (!cell) return false;
            
            const initialText = cell.getAttribute('data-initial-text');
            const contentSpan = cell.querySelector('.cell-content');
            const contentButton = cell.querySelector('button');
            
            let currentValue = '';
            
            if (contentSpan) {
                currentValue = contentSpan.textContent.trim();
            } else if (contentButton) {
                currentValue = contentButton.textContent.trim();
            }
            
            if (!currentValue || currentValue === initialText) {
                return false;
            }
        }
        return true;
    }

    // --- V√©rification de compl√©tion des cases facultatives ---
    function checkOptionalCompletion() {
        for (const id of optionalCells) {
            const cell = document.getElementById(id);
            if (!cell) return false;
            
            const initialText = cell.getAttribute('data-initial-text');
            const contentSpan = cell.querySelector('.cell-content');
            const contentButton = cell.querySelector('button');
            
            let currentValue = '';
            
            if (contentSpan) {
                currentValue = contentSpan.textContent.trim();
            } else if (contentButton) {
                currentValue = contentButton.textContent.trim();
            }
            
            if (!currentValue || currentValue === initialText) {
                return false;
            }
        }
        return true;
    }

    // --- V√©rification de compl√©tion g√©n√©rale ---
    function checkCompletion() {
        // V√©rifier si toutes les cases obligatoires sont remplies
        if (checkRequiredCompletion()) {
            // V√©rifier si les cases facultatives sont √©galement remplies
            if (checkOptionalCompletion()) {
                // Toutes les cases sont remplies - afficher notification de succ√®s
                showCompletionNotification();
                return true;
            }
        }
        return false;
    }

    function showCompletionNotification() {
        const notification = document.getElementById('notification-banner');
        notification.textContent = 'T√¢che compl√®te ! üéâ';
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
            resetAll();
        }, 2000);
    }

    // --- Fonction d'actualisation manuelle ---
    function manualRefresh() {
        resetAll();
        showRefreshNotification();
    }

    function showRefreshNotification() {
        const notification = document.getElementById('notification-banner');
        notification.textContent = 'Toutes les cases ont √©t√© r√©initialis√©es ! üîÑ';
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 2000);
    }

    // --- Configuration initiale ---
    const a1Menu = document.querySelector('#a1 .dropdown-menu');
    for (let i = 1; i <= 10; i++) {
        a1Menu.appendChild(createDropdownItem(`P${i}`));
    }

    const d1Menu = document.querySelector('#d1 .dropdown-menu');
    initialUsers.forEach(user => {
        d1Menu.appendChild(createDropdownItem(user));
    });
    const addUserItem = createDropdownItem('+');
    addUserItem.classList.add('add-item');
    d1Menu.appendChild(addUserItem);

    resetC2();

    const c3Menu = document.querySelector('#c3 .dropdown-menu');
    const xylophageItem = createDropdownItem('Xylophage');
    xylophageItem.dataset.colorState = '0';
    c3Menu.appendChild(xylophageItem);

    const row4Cells = ['#a4', '#b4', '#c4', '#d4'];
    const row4Options = ['Vide', '1', '2', '3'];
    row4Cells.forEach(cellId => {
        const menu = document.querySelector(`${cellId} .dropdown-menu`);
        row4Options.forEach(optionText => {
            menu.appendChild(createDropdownItem(optionText));
        });
    });

    loadResults();
    loadDefaultUser(); // Charger l'utilisateur par d√©faut de D1 au d√©marrage
    loadDefaultLocales(); // Charger les locales par d√©faut de A1 au d√©marrage

    // --- √âv√©nements ---
    const grid = document.querySelector('.grid');
    let activeMenu = null;

    grid.addEventListener('click', function(event) {
        const cell = event.target.closest('.cell');
        if (!cell || cell.classList.contains('empty-cell')) return;

        // Emp√™cher l'interaction avec D1 si un utilisateur par d√©faut est actif
        if (cell.id === 'd1' && cell.classList.contains('default-user-active')) {
            return;
        }

        if (event.target.tagName === 'BUTTON') {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const timeString = `${hours}:${minutes}`;
            
            cell.innerHTML = `<span class="cell-content">${timeString}</span>`;
            cell.style.cursor = 'default';
            updateResults();
            checkCompletion();
            return;
        }

        const dropdownItem = event.target.closest('.dropdown-item');
        if (dropdownItem) {
            const cellId = cell.id;

            // A1 : G√©rer l'ajout de locales par d√©faut
            if (cellId === 'a1') {
                const selectedLocale = dropdownItem.querySelector('.dropdown-item-content').textContent;
                // Retirer le pr√©fixe ‚òÖ s'il existe
                const cleanLocale = selectedLocale.replace(/^‚òÖ /, '').replace(/ \(par d√©faut\)$/, '');
                
                // Ajouter comme locale par d√©faut et afficher dans la cellule
                addDefaultLocale(cleanLocale);
                
                updateResults();
                checkCompletion();
                return;
            }

            // D1 : G√©rer l'ajout de nouveaux utilisateurs
            if (cellId === 'd1' && dropdownItem.classList.contains('add-item')) {
                const newName = prompt("Veuillez entrer un nouveau pr√©nom :");
                if (newName && newName.trim() !== '') {
                    const newItem = createDropdownItem(newName.trim());
                    const d1Menu = document.querySelector('#d1 .dropdown-menu');
                    // Ins√®re le nouvel item avant le bouton "+ Ajouter"
                    d1Menu.insertBefore(newItem, dropdownItem); 
                    updateResults();
                    checkCompletion();
                }
                return;
            }

            // D1 : G√©rer la s√©lection d'un utilisateur comme par d√©faut
            if (cellId === 'd1' && !dropdownItem.classList.contains('add-item')) {
                const selectedUser = dropdownItem.querySelector('.dropdown-item-content').textContent;
                // Retirer le pr√©fixe ‚òÖ s'il existe
                const cleanUser = selectedUser.replace(/^‚òÖ /, '').replace(/ \(par d√©faut\)$/, '');
                
                // D√©finir comme utilisateur par d√©faut
                setDefaultUser(cleanUser);
                
                updateResults();
                checkCompletion();
                return;
            }

            // C2 : G√©rer R et Rat
            if (cellId === 'c2') {
                const text = dropdownItem.querySelector('.dropdown-item-content').textContent;
                
                // Si on clique sur R
                if (text === 'R') {
                    cell.querySelector('.cell-content').textContent = 'R';
                    cell.classList.remove('text-green', 'text-red');
                    // Ne pas r√©initialiser le menu - seulement afficher R
                    updateResults();
                    checkCompletion();
                    return;
                }

                // Si on clique sur Rat
                if (text === 'Rat') {
                    cell.querySelector('.cell-content').textContent = 'Rat';
                    cell.classList.remove('text-green', 'text-red');
                    showPlacesToControl(); // Afficher les endroits
                    updateResults();
                    checkCompletion();
                    return;
                }

                // Gestion des couleurs pour les endroits (mode Rat)
                if (ratMode && dropdownItem.dataset.colorState !== undefined) {
                    let currentState = parseInt(dropdownItem.dataset.colorState || '0');
                    currentState = (currentState + 1) % 3;
                    dropdownItem.dataset.colorState = currentState;

                    dropdownItem.classList.remove('text-green', 'text-red');
                    cell.classList.remove('text-green', 'text-red');

                    // Mettre √† jour la liste des √©l√©ments color√©s
                    const itemText = dropdownItem.querySelector('.dropdown-item-content').textContent;
                    
                    if (currentState === 1) {
                        dropdownItem.classList.add('text-green');
                        cell.classList.add('text-green');
                        coloredItemsC2[itemText] = 'green';
                    } else if (currentState === 2) {
                        dropdownItem.classList.add('text-red');
                        cell.classList.add('text-red');
                        coloredItemsC2[itemText] = 'red';
                    } else {
                        // Retirer la couleur
                        delete coloredItemsC2[itemText];
                        cell.classList.remove('text-green', 'text-red');
                    }

                    // Mettre √† jour l'affichage dans la cellule
                    updateColoredDisplay();
                    updateResults();
                    checkCompletion();
                    return;
                }

                // Si on est en mode Rat et on clique sur "+"
                if (ratMode && dropdownItem.classList.contains('add-item')) {
                    const newPlace = prompt("Ajouter un nouvel endroit √† contr√¥ler:");
                    if (newPlace && newPlace.trim()) {
                        placesToControl.push(newPlace.trim());
                        const newItem = createDropdownItem(newPlace.trim());
                        newItem.dataset.colorState = '0';
                        const c2Menu = document.querySelector('#c2 .dropdown-menu');
                        c2Menu.insertBefore(newItem, dropdownItem);
                        updateResults();
                        checkCompletion();
                    }
                    return;
                }

                // Si on est en mode Rat et on clique sur un endroit (sans couleur)
                if (ratMode) {
                    cell.querySelector('.cell-content').textContent = text;
                    cell.classList.remove('text-green', 'text-red');
                    updateResults();
                    checkCompletion();
                    return;
                }
            }

            // C3 : Gestion des couleurs pour Xylophage
            if (cellId === 'c3' && dropdownItem.dataset.colorState !== undefined) {
                let currentState = parseInt(dropdownItem.dataset.colorState || '0');
                currentState = (currentState + 1) % 3;
                dropdownItem.dataset.colorState = currentState;

                dropdownItem.classList.remove('text-green', 'text-red');
                cell.classList.remove('text-green', 'text-red');

                if (currentState === 1) {
                    dropdownItem.classList.add('text-green');
                    cell.classList.add('text-green');
                } else if (currentState === 2) {
                    dropdownItem.classList.add('text-red');
                    cell.classList.add('text-red');
                }

                cell.querySelector('.cell-content').textContent = 'Xylophage';
                updateResults();
                checkCompletion();
                return;
            }

            // Autres cellules avec gestion des couleurs
            if (dropdownItem.dataset.colorState !== undefined) {
                let currentState = parseInt(dropdownItem.dataset.colorState || '0');
                currentState = (currentState + 1) % 3;
                dropdownItem.dataset.colorState = currentState;

                dropdownItem.classList.remove('text-green', 'text-red');
                cell.classList.remove('text-green', 'text-red');

                if (currentState === 1) {
                    dropdownItem.classList.add('text-green');
                    cell.classList.add('text-green');
                } else if (currentState === 2) {
                    dropdownItem.classList.add('text-red');
                    cell.classList.add('text-red');
                }

                const contentSpan = cell.querySelector('.cell-content');
                contentSpan.textContent = dropdownItem.querySelector('.dropdown-item-content').textContent;
                updateResults();
                checkCompletion();
                return;
            }

            // Autres cas normaux
            const contentSpan = cell.querySelector('.cell-content');
            contentSpan.textContent = dropdownItem.querySelector('.dropdown-item-content').textContent;
            cell.classList.remove('text-green', 'text-red');
            updateResults();
            checkCompletion();
            return;
        }

        const menu = cell.querySelector('.dropdown-menu');
        if (menu) {
            if (activeMenu && activeMenu !== menu) {
                activeMenu.classList.remove('show');
            }
            menu.classList.toggle('show');
            activeMenu = menu.classList.contains('show') ? menu : null;
        }
    });

    document.addEventListener('click', function(event) {
        if (!event.target.closest('.cell') && activeMenu) {
            activeMenu.classList.remove('show');
            activeMenu = null;
        }
    });

    // Double-click seulement sur "R" pour r√©initialiser
    document.querySelector('#c2 .dropdown-menu').addEventListener('dblclick', function(event) {
        const dropdownItem = event.target.closest('.dropdown-item');
        if (dropdownItem && dropdownItem.querySelector('.dropdown-item-content').textContent === 'R') {
            resetC2();
            updateResults();
            checkCompletion();
        }
    });

    // Bouton d'actualisation
    document.getElementById('refresh-button').addEventListener('click', manualRefresh);
});
</script>
</body>
</html>
